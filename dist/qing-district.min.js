/* qing-district v0.0.1 | (c) Mycolorway Design | MIT License */
!function(t,e){"object"==typeof module&&module.exports?module.exports=e(require("jquery"),require("qing-module")):t.QingDistrict=e(t.jQuery,t.QingModule)}(this,function(t,e){var r=require=function t(e,r,i){function o(s,c){if(!r[s]){if(!e[s]){var p="function"==typeof require&&require;if(!c&&p)return p(s,!0);if(n)return n(s,!0);var u=new Error("Cannot find module '"+s+"'");throw u.code="MODULE_NOT_FOUND",u}var a=r[s]={exports:{}};e[s][0].call(a.exports,function(t){var r=e[s][1][t];return o(r?r:t)},a,a.exports,t,e,r,i)}return r[s].exports}for(var n="function"==typeof require&&require,s=0;s<i.length;s++)o(i[s]);return o}({1:[function(t,r,i){var o,n,s,c=function(t,e){function r(){this.constructor=t}for(var i in e)p.call(e,i)&&(t[i]=e[i]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},p={}.hasOwnProperty;n=t("./view/list-view.coffee"),s=t("./view/ref.coffee"),o=function(t){function e(){var t;e.__super__.constructor.apply(this,arguments),t=this.opts,this.target=t.target,this.type=t.type,this.dataStore=t.dataStore,this.codes=t.codes,this.field=this.target.find("[data-"+this.type+"-field]"),this.dataMap=this.dataStore.findByType(this.type),this.listView=new n,this.ref=new s,this._init(),this._bind()}return c(e,t),e.prototype.opts={target:null,dataStore:null,type:null,codes:[]},e.prototype._init=function(){var t,e;return t=this.field.val(),(e=this.dataMap[t])&&(this.current=e,this.ref.linkTo(e),this.listView.highlightItem(e)),this.render()},e.prototype._bind=function(){return this.listView.on("select",function(t){return function(e,r){return t.selectByCode(r),t.listView.hide(),t.trigger("afterSelect",[t]),!1}}(this)),this.ref.on("visit",function(t){return function(e,r){return t.selectByCode(r),t.listView.show(),t.trigger("visit",t),!1}}(this))},e.prototype.selectByCode=function(t){return this.current=this.dataMap[t],this.ref.linkTo(this.current),this.listView.highlightItem(this.current),this.field.val(this.current.code),this},e.prototype.reset=function(){return this.field.val(null),this.ref.reset(),this.listView.hide(),this},e.prototype.setCodes=function(t){return this.codes=t,this},e.prototype.isSelected=function(){return!!this.field.val()},e.prototype.render=function(){var t,e,r,i,o,n;if("all"===this.codes&&(this.codes=Object.keys(this.dataMap)),this.codes){for(r=[],o=this.codes,e=0,i=o.length;e<i;e++)t=o[e],r.push(this.dataMap[t]);return this.listView.render(r),this.listView.highlightItem(this.dataMap[null!=(n=this.current)?n.code:void 0]),this.listView.show(),this}},e}(e),r.exports=o},{"./view/list-view.coffee":3,"./view/ref.coffee":5}],2:[function(e,r,i){var o;o=function(){function e(t){this.data=this.formatData(t)}return e.prototype.findByType=function(t){return this.data[t]},e.prototype.formatData=function(e){var r,i,o,n,s,c,p,u,a,l,h,d,f,y;if(t.isArray(e)){for(d={},i={},o={},s=0,u=e.length;s<u;s++)for(h=e[s],d[h.code]={code:h.code,name:h.name,cities:[]},f=h.cities,c=0,a=f.length;c<a;c++)for(r=f[c],d[h.code].cities.push(r.code),i[r.code]={code:r.code,name:r.name,counties:[]},y=r.counties,p=0,l=y.length;p<l;p++)n=y[p],i[r.code].counties.push(n.code),o[n.code]={code:n.code,name:n.name};return{province:d,city:i,county:o}}},e}(),r.exports=o},{}],3:[function(r,i,o){var n,s=function(t,e){function r(){this.constructor=t}for(var i in e)c.call(e,i)&&(t[i]=e[i]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},c={}.hasOwnProperty;n=function(e){function r(){r.__super__.constructor.apply(this,arguments),this.el=t('<div class="district-list">\n  <dl><dd></dd></dl>\n</div>').hide(),this.el.on("click","a",function(e){return function(r){var i;return i=t(r.currentTarget),e.trigger("select",[i.data("code")])}}(this))}return s(r,e),r.prototype.highlightItem=function(t){if(t)return this.el.find("a").removeClass("active"),this.el.find("[data-code="+t.code+"]").addClass("active")},r.prototype.show=function(){return this.el.show()},r.prototype.hide=function(){return this.el.hide()},r.prototype.render=function(e){var r,i,o,n;for(this.el.find("dd").empty(),n=[],r=0,o=e.length;r<o;r++)i=e[r],n.push(t("<a title='"+i.name+"' data-code='"+i.code+"' href='javascript:;'>\n  "+i.name+"\n</a>").appendTo(this.el.find("dd")));return n},r}(e),i.exports=n},{}],4:[function(r,i,o){var n,s=function(t,e){function r(){this.constructor=t}for(var i in e)c.call(e,i)&&(t[i]=e[i]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},c={}.hasOwnProperty;n=function(e){function r(){r.__super__.constructor.apply(this,arguments),this.wrapper=t(this.opts.wrapper),this.target=t(this.opts.target),this.el=this.wrapper.find(".district-popover")}return s(r,e),r.prototype.opts={target:null,wrapper:null},r.prototype.setActive=function(t){return t?this._show():this._hide()},r.prototype._show=function(){return this.el.show(),t(document).off("click.qing-district").on("click.qing-district",function(e){return function(r){var i;if(i=t(r.target),e.wrapper.hasClass("active")&&!e.target.has(i).length&&!i.is(e.target))return e._hide()}}(this)),this.trigger("show")},r.prototype._hide=function(){return t(document).off(".qing-district"),this.el.hide(),this.trigger("hide")},r}(e),i.exports=n},{}],5:[function(r,i,o){var n,s=function(t,e){function r(){this.constructor=t}for(var i in e)c.call(e,i)&&(t[i]=e[i]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},c={}.hasOwnProperty;n=function(e){function r(){this.el=t('<a class="district-item" href="javascript:;"></a>').hide(),this.el.on("click",function(e){return function(r){return e.trigger("visit",[t(r.currentTarget).data("code")])}}(this))}return s(r,e),r.prototype.linkTo=function(t){return this.el.text(t.name).data("code",t.code).show()},r.prototype.reset=function(){return this.el.text("").hide()},r}(e),i.exports=n},{}],"qing-district":[function(r,i,o){var n,s,c,p,u=function(t,e){function r(){this.constructor=t}for(var i in e)a.call(e,i)&&(t[i]=e[i]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},a={}.hasOwnProperty;s=r("./data-store.coffee"),c=r("./view/popover.coffee"),n=r("./controller.coffee"),p=function(e){function r(e){if(r.__super__.constructor.apply(this,arguments),this.opts=t.extend({},r.opts,this.opts),this.el=t(this.opts.el),!(this.el.length>0))throw new Error("QingDistrict: option el is required");if(!t.isFunction(this.opts.dataSource))throw new Error("QingDistrict: option dataSource is required");this._render(),this.popover=new c({target:this.el,wrapper:this.wrapper}),this.opts.dataSource.call(null,function(t){return function(e){var r,i,o,c,p;for(t.dataStore=new s(e),t.register(new n({target:t.el,dataStore:t.dataStore,type:"province",codes:"all"})),t.register(new n({target:t.el,dataStore:t.dataStore,type:"city"})),t.register(new n({target:t.el,dataStore:t.dataStore,type:"county"})),t._bind(),c=["province","city","county"],i=0,o=c.length;i<o;i++)p=c[i],r=t.controllers[p],r.isSelected()&&r.trigger("afterSelect",[r,!0]);return t.isFullFilled()&&t.setInfoBarActive(!0),t.trigger("ready")}}(this))}return u(r,e),r.opts={el:null,dataSource:null},r._tpl='<div class="qing-district-wrapper">\n  <div class="district-info empty">\n    <span class="placeholder">点击选择城市</span>\n  </div>\n  <div class="district-popover">\n  </div>\n</div>',r.prototype.isFullFilled=function(){var t,e,r,i;for(r=["province","city","county"],t=0,e=r.length;t<e;t++)if(i=r[t],!this.controllers[i].isSelected())return!1;return!0},r.prototype.register=function(t){return this.el.find(".district-info").append(t.ref.el),this.popover.el.append(t.listView.el),this.controllers||(this.controllers={}),this.controllers[t.type]=t},r.prototype.setInfoBarActive=function(t){return this.wrapper.find(".district-info").toggleClass("empty",!t)},r.prototype._render=function(){return this.wrapper=t(r._tpl).data("district",this).prependTo(this.el),this.el.addClass(" qing-district").data("qingDistrict",this)},r.prototype._bind=function(){return this.wrapper.on("click",".district-info",function(t){return function(){return t.wrapper.hasClass("active")?t.popover.setActive(!1):(t.controllers.province.render(),t.popover.setActive(!0))}}(this)),this.popover.on("show",function(){return this.wrapper.addClass("active")}).on("hide",function(t){return function(){var e,r,i,o;if(t.wrapper.removeClass("active"),!t.isFullFilled()){r=t.controllers,i=[];for(o in r)e=r[o],e.reset(),i.push(t.setInfoBarActive(!1));return i}}}(this)),this.controllers.province.on("afterSelect",function(t){return function(e,r,i){var o,n;if(i||t.setInfoBarActive(!0),n=r.current.cities,o=t.controllers.city,1===n.length&&o.dataMap[n[0]].name===r.current.name?(o.reset().selectByCode(n[0]).ref.el.hide(),o.listView.hide(),i||o.trigger("afterSelect",o)):(i||o.reset(),o.setCodes(n).render()),!i)return t.controllers.county.reset()}}(this)).on("visit",function(t){return function(e){return t.controllers.city.listView.hide(),t.controllers.county.listView.hide(),t.popover.setActive(!0)}}(this)),this.controllers.city.on("afterSelect",function(t){return function(e,r,i){var o;return i||t.setInfoBarActive(!0),o=r.current.counties,i||t.controllers.county.reset(),t.controllers.county.setCodes(o).render()}}(this)).on("visit",function(t){return function(e){return t.controllers.province.listView.hide(),t.controllers.county.listView.hide(),t.popover.setActive(!0)}}(this)),this.controllers.county.on("afterSelect",function(t){return function(e,r,i){return i||t.setInfoBarActive(!0),t.popover.setActive(!1)}}(this)).on("visit",function(t){return function(e){return t.controllers.province.listView.hide(),t.controllers.city.listView.hide(),t.popover.setActive(!0)}}(this))},r.prototype.destroy=function(){return this.el.empty().removeData("qingDistrict")},r}(e),i.exports=p},{"./controller.coffee":1,"./data-store.coffee":2,"./view/popover.coffee":4}]},{},[]);return r("qing-district")});