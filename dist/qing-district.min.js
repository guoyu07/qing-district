/* qing-district v0.0.1 | (c) Mycolorway Design | MIT License */
!function(t,e){"object"==typeof module&&module.exports?module.exports=e(require("jquery"),require("qing-module")):t.QingDistrict=e(t.jQuery,t.QingModule)}(this,function(t,e){var i=require=function t(e,i,r){function o(s,c){if(!i[s]){if(!e[s]){var l="function"==typeof require&&require;if(!c&&l)return l(s,!0);if(n)return n(s,!0);var d=new Error("Cannot find module '"+s+"'");throw d.code="MODULE_NOT_FOUND",d}var a=i[s]={exports:{}};e[s][0].call(a.exports,function(t){var i=e[s][1][t];return o(i?i:t)},a,a.exports,t,e,i,r)}return i[s].exports}for(var n="function"==typeof require&&require,s=0;s<r.length;s++)o(r[s]);return o}({1:[function(e,i,r){var o,n=function(t,e){return function(){return t.apply(e,arguments)}};o=function(){function e(e,i,r){this.context=e,this.type=i,this.codes=null!=r?r:[],this._onClickListItem=n(this._onClickListItem,this),this.ref=t('<a class="district-item" href="javascript:;"></a>').hide(),this.list=t('<div class="district-list"><dl><dd></dd></dl></div>').hide(),this.field=this.context.el.find("[data-"+this.type+"-field]"),this.dataMap=this.context.data[this.type],this._bind(),this._init()}return e.prototype._init=function(){var t,e;return t=this.field.val(),(e=this.dataMap[t])&&(this.current=e,this.ref.text(e.name).show(),this.list.find("[data-code="+t+"]").addClass("active")),this.render()},e.prototype._bind=function(){return this.list.on("click","a",this._onClickListItem),this.ref.on("click",function(t){return function(e){return t.show(),t.context.showPopover(),!1}}(this))},e.prototype._onClickListItem=function(e){var i;return i=t(e.currentTarget),this.list.find("a").removeClass("active"),i.addClass("active"),this.selectByCode(i.data("code")),this.field.length>0?(this.context.afterSelect(this.type),!1):(this.context.hidePopover(),!1)},e.prototype.selectByCode=function(t){return this.setCurrentByCode(t),this.ref.text(this.current.name).show(),this.field.val(this.current.code),this},e.prototype.setCurrentByCode=function(t){return this.current=this.dataMap[t],this},e.prototype.reset=function(){return this.field.val(null),this.ref.text("").hide(),this},e.prototype.show=function(){return this.context.el.find(".district-list").hide(),this.list.show(),this},e.prototype.setCodes=function(t){return this.codes=t,this},e.prototype.isSelected=function(){return!!this.field.val()},e.prototype.render=function(){var e,i,r,o,n,s,c;for(this.list.find("dd").empty(),"all"===this.codes&&(this.codes=Object.keys(this.dataMap)),s=this.codes,o=0,n=s.length;o<n;o++)e=s[o],r=this.dataMap[e],t("<a title='"+r.name+"' data-code='"+e+"' href='javascript:;'>\n  "+r.name+"\n</a>").appendTo(this.list.find("dd"));return(i=null!=(c=this.current)?c.code:void 0)&&this.list.find("[data-code="+i+"]").addClass("active"),this},e}(),i.exports=o},{}],2:[function(e,i,r){var o;o={normalizeData:function(e){var i,r,o,n,s,c,l,d,a,u,h,p,f,v;if(t.isArray(e)){for(p={},r={},o={},s=0,d=e.length;s<d;s++)for(h=e[s],p[h.code]={code:h.code,name:h.name,cities:[]},f=h.cities,c=0,a=f.length;c<a;c++)for(i=f[c],p[h.code].cities.push(i.code),r[i.code]={code:i.code,name:i.name,counties:[]},v=i.counties,l=0,u=v.length;l<u;l++)n=v[l],r[i.code].counties.push(n.code),o[n.code]={code:n.code,name:n.name};return{province:p,city:r,county:o}}}},i.exports=o},{}],"qing-district":[function(i,r,o){var n,s,c,l=function(t,e){function i(){this.constructor=t}for(var r in e)d.call(e,r)&&(t[r]=e[r]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},d={}.hasOwnProperty;c=i("./util.coffee"),n=i("./controller.coffee"),s=function(e){function i(e){if(i.__super__.constructor.apply(this,arguments),this.opts=t.extend({},i.opts,this.opts),this.el=t(this.opts.el),!(this.el.length>0))throw new Error("QingDistrict: option el is required");if(!t.isFunction(this.opts.dataSource))throw new Error("QingDistrict: option dataSource is required");this.opts.dataSource.call(null,function(t){return function(e){var i,r,o,s;for(t.data=c.normalizeData(e),t._render(),t._bind(),t.register(new n(t,"province","all")),t.register(new n(t,"city")),t.register(new n(t,"county")),o=["province","city","county"],i=0,r=o.length;i<r;i++)s=o[i],t.controllers[s].isSelected()&&t.afterSelect(s,!0);return t.isFullFilled()&&t.resetSelectedInfoStatus(!0),t.trigger("ready")}}(this))}return l(i,e),i.opts={el:null,dataSource:null},i._tpl='<div class="qing-district">\n  <div class="district-info empty">\n    <span class="placeholder">点击选择城市</span>\n  </div>\n  <div class="district-popover">\n  </div>\n</div>',i.prototype.isFullFilled=function(){var t,e,i,r;for(i=["province","city","county"],t=0,e=i.length;t<e;t++)if(r=i[t],!this.controllers[r].isSelected())return!1;return!0},i.prototype.register=function(t){return this.el.find(".district-info").append(t.ref),this.el.find(".district-popover").append(t.list),this.controllers||(this.controllers={}),this.controllers[t.type]=t},i.prototype.resetSelectedInfoStatus=function(t){return this.selectEl.find(".district-info").toggleClass("empty",!t)},i.prototype.afterSelect=function(t,e){var i,r,o;switch(null==e&&(e=!1),e||this.resetSelectedInfoStatus(!0),t){case"province":if(o=this.controllers.province.current,r=o.cities,i=this.controllers.city,1===r.length&&i.dataMap[r[0]].name===o.name?(i.reset().selectByCode(r[0]).ref.hide(),e||this.afterSelect("city")):(e||i.reset(),i.setCodes(r).render(!0).show()),!e)return this.controllers.county.reset();break;case"city":return r=this.controllers.city.current.counties,e||this.controllers.county.reset(),this.controllers.county.setCodes(r).render(!0).show();default:return this.hidePopover()}},i.prototype._render=function(){return this.selectEl=t(i._tpl).data("district",this).prependTo(this.el),this.el.addClass(" qing-district").data("qingDistrict",this)},i.prototype._bind=function(){return this.selectEl.on("click",".district-info",function(t){return function(){return t.selectEl.hasClass("active")?t.hidePopover():(t.controllers.province.show(),t.showPopover())}}(this))},i.prototype.showPopover=function(){return this.selectEl.addClass("active"),t(document).off("click.qing-district").on("click.qing-district",function(e){return function(i){var r;if(r=t(i.target),e.selectEl.hasClass("active")&&!e.el.has(r).length&&!r.is(e.el))return e.hidePopover()}}(this)),this.trigger("showPopover")},i.prototype.hidePopover=function(){var e,i,r,o;if(this.selectEl.removeClass("active"),t(document).off(".qing-district"),this.trigger("hidePopover"),!this.isFullFilled()){i=this.controllers,r=[];for(o in i)e=i[o],e.reset(),r.push(this.resetSelectedInfoStatus(!1));return r}},i.prototype.destroy=function(){return this.el.empty().removeData("qingDistrict")},i}(e),r.exports=s},{"./controller.coffee":1,"./util.coffee":2}]},{},[]);return i("qing-district")});